name: Ripplearc Linter

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  lint:
    name: Run ripplearc_linter on changed files
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Attempt Rebase (Check Mergeability)
        id: rebase
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git fetch origin ${{ github.base_ref }}
          echo "Attempting to rebase on origin/${{ github.base_ref }}..."
          
          if ! git rebase origin/${{ github.base_ref }}; then
            echo "::error::Merge conflict detected! The PR cannot be rebased onto ${{ github.base_ref }}."
            echo "::error::Please resolve conflicts locally and push again."
            exit 1
          fi
          
          echo "Rebase successful! Code is now up-to-date with ${{ github.base_ref }}."

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Collect changed Dart files
        id: changed
        run: |
          CHANGED_DART_FILES=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }} HEAD -- '*.dart')

          if [ -z "$CHANGED_DART_FILES" ]; then
            echo "has_changed_files=false" >> "$GITHUB_OUTPUT"
            echo "No Dart files changed; skipping ripplearc_linter."
          else
            DART_FILES_SPACE_SEPARATED=$(echo "$CHANGED_DART_FILES" | tr '\n' ' ')
            echo "has_changed_files=true" >> "$GITHUB_OUTPUT"
            echo "dart_files=$DART_FILES_SPACE_SEPARATED" >> "$GITHUB_OUTPUT"
            
            echo "Changed Dart files found:"
            echo "$CHANGED_DART_FILES"
          fi

      - name: Run ripplearc_linter
        if: steps.changed.outputs.has_changed_files == 'true'
        run: |
          RIPPLEARC_LINTER_RULES="prefer_fake_over_mock,no_optional_operators_in_tests,document_fake_parameters,document_interface,todo_with_story_links,no_internal_method_docs,avoid_test_timeouts,private_subject,sealed_over_dynamic"
          dart run ripplearc_linter:standalone_checker --rules "$RIPPLEARC_LINTER_RULES" ${{ steps.changed.outputs.dart_files }}